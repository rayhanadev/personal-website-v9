---
import Analytics from "@vercel/analytics/astro";
import SpeedInsights from "@vercel/speed-insights/astro";
import { Font } from "astro:assets";
import { ClientRouter } from "astro:transitions";

import Favicons from "../components/Favicons.astro";
import SEO from "../components/SEO.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";

import "../styles/global.css";

interface Props {
  title: string;
  description: string;
  keywords?: string[];
}

const { title, description, keywords } = Astro.props;
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />

        <Font cssVariable="--font-general-sans" preload />

        <Favicons />
        <SEO title={title} description={description} keywords={keywords} />

        <meta
            name="robots"
            content="follow, index, max-snippet:-1, max-video-preview:-1, max-image-preview:large"
        />

        <link rel="sitemap" href="/sitemap-index.xml" />
        <link
            rel="alternate"
            type="application/rss+xml"
            title="Ray's Substack"
            href="https://rayhanadev.substack.com/feed"
        />

        <Analytics />
        <SpeedInsights />
        <ClientRouter />

        <script>
            if (import.meta.env.DEV) {
                import("react-grab");
            }
        </script>
    </head>
    <body class="flex flex-col h-dvh w-full antialiased">
        <canvas id="gol-canvas" class="fixed inset-0 pointer-events-none -z-10 opacity-0 invisible" transition:persist></canvas>
        <main class="flex flex-col items-center flex-1 py-20">
            <Header />
            <slot />
            <Footer />
        </main>
        <script>
            import { createGameOfLife, setupKonamiCode } from "../lib/game-of-life";

            let gol: ReturnType<typeof createGameOfLife> | null = null;
            let active = false;
            let cleanupKonami: (() => void) | null = null;

            const isMainPage = (): boolean => window.location.pathname === "/";
            const getCanvas = (): HTMLCanvasElement | null =>
                document.getElementById("gol-canvas") as HTMLCanvasElement | null;

            function showGame(canvas: HTMLCanvasElement): void {
                active = true;
                canvas.classList.remove("opacity-0", "invisible");
                document.body.classList.add("select-none");
                gol?.start();
            }

            function hideGame(canvas: HTMLCanvasElement): void {
                active = false;
                gol?.stop(() => {
                    canvas.classList.add("opacity-0", "invisible");
                    document.body.classList.remove("select-none");
                });
            }

            function init(): void {
                const canvas = getCanvas();
                if (!canvas) return;

                if (active) {
                    if (isMainPage()) {
                        document.body.classList.add("select-none");
                    } else {
                        hideGame(canvas);
                    }
                }

                if (!gol) {
                    gol = createGameOfLife(canvas);
                    window.addEventListener("keydown", (e) => {
                        if (e.key === "Escape" && active) {
                            const c = getCanvas();
                            if (c) hideGame(c);
                        }
                    });
                }

                cleanupKonami?.();
                cleanupKonami = setupKonamiCode(() => {
                    if (!active && isMainPage()) showGame(canvas);
                });
            }

            document.addEventListener("astro:before-preparation", () => {
                const canvas = getCanvas();
                if (active && canvas) hideGame(canvas);
            });

            document.addEventListener("astro:page-load", init);
            init();
        </script>
    </body>
</html>
