---
interface Props {
  href: string;
  class?: string;
  unstyled?: boolean;
  [key: string]: any;
}

const { href, class: className, unstyled = false, ...rest } = Astro.props;

const isExternal = href.startsWith("http://") || href.startsWith("https://");
const linkClass = unstyled ? className : ["link", className];
---

{isExternal ? (
  <a href={href} target="_blank" rel="noopener noreferrer" class:list={linkClass} {...rest}>
    <slot />
  </a>
) : (
  <a href={href} class:list={linkClass} {...rest}>
    <slot />
  </a>
)}

<style>
  .link {
    --origin: bottom;
    --scale: scaleY(0);
    position: relative;
    text-decoration: underline;
    text-underline-offset: 2px;
    padding: 2px 4px;
    margin: -2px -4px;
    border-radius: 2px;
    transition: color 200ms ease-out;
  }

  .link::before {
    content: "";
    position: absolute;
    inset: 0;
    background-color: black;
    border-radius: 2px;
    transform: var(--scale);
    transform-origin: var(--origin);
    transition: transform var(--duration-hover) var(--ease-hover);
    z-index: -1;
    will-change: transform;
  }

  .link.no-transition::before {
    transition: none;
  }

  .link.exit-slow::before {
    transition: transform var(--duration-hover-slow) var(--ease-hover);
  }

  @media (hover: hover) and (pointer: fine) {
    .link.active {
      color: white;
      text-decoration: none;
    }

    .link.active::before {
      transform: scale(1);
    }
  }
</style>

<script>
  import { getEdge, getScaleTransform, type Edge } from '../lib/edge-animation';

  function applyEdge(link: HTMLElement, edge: Edge): void {
    link.style.setProperty('--origin', edge);
    link.style.setProperty('--scale', getScaleTransform(edge));
  }

  function initLinks(): void {
    document.querySelectorAll<HTMLElement>('.link').forEach((link) => {
      link.addEventListener('mouseenter', (e) => {
        const edge = getEdge(e, link.getBoundingClientRect());
        link.classList.add('no-transition');
        link.classList.remove('exit-slow', 'active');
        applyEdge(link, edge);
        void link.offsetHeight;
        link.classList.remove('no-transition');
        link.classList.add('active');
      });

      link.addEventListener('mouseleave', (e) => {
        const edge = getEdge(e, link.getBoundingClientRect());
        applyEdge(link, edge);
        link.classList.toggle('exit-slow', edge === 'top');
        link.classList.remove('active');
      });
    });
  }

  initLinks();
  document.addEventListener('astro:page-load', initLinks);
</script>
