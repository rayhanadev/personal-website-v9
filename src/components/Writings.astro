---
interface SubstackPost {
  title: string;
  post_date: string;
  canonical_url: string;
}

const response = await fetch("https://rayhanadev.substack.com/api/v1/posts?limit=10");
const posts: SubstackPost[] = await response.json();
---

<section class="flex-1 mb-6 flex flex-col gap-4">
  <h2 class="text-[20px] leading-[22px] font-semibold">Writings</h2>
  <div class="writings-list relative flex flex-col">
    <div class="writings-indicator absolute bg-black rounded-sm pointer-events-none will-change-transform"></div>
    {posts.map((post) => (
      <a
        href={post.canonical_url}
        target="_blank"
        rel="noopener noreferrer"
        class="writings-row relative z-1 py-1 outline-none flex gap-6 w-fit"
      >
        <span class="text-base leading-5 text-[#979494] shrink-0 w-[100px] transition-colors duration-150 ease-out">
          {new Date(post.post_date).toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" })}
        </span>
        <span class="writings-title text-base leading-5 underline underline-offset-2 decoration-[#ccc] w-fit transition-colors duration-200 ease-out">
          {post.title}
        </span>
      </a>
    ))}
  </div>
</section>

<style>
  .writings-indicator {
    top: var(--indicator-y, 0);
    left: var(--indicator-x, 0);
    width: var(--indicator-width, 0);
    height: var(--indicator-height, 0);
    transform: scaleY(0);
    transform-origin: bottom;
    transition: transform var(--duration-hover) var(--ease-hover);
  }

  .writings-list.active .writings-indicator {
    transform: scaleY(1);
    transition:
      transform var(--duration-hover) var(--ease-hover),
      top var(--duration-slide) var(--ease-slide),
      left var(--duration-slide) var(--ease-slide),
      width var(--duration-slide) var(--ease-slide),
      height var(--duration-slide) var(--ease-slide);
  }

  .writings-list.active .writings-title.hovered {
    color: white;
    text-decoration: none;
  }

  .writings-row:hover span:first-child,
  .writings-row:focus span:first-child {
    color: #4a4747;
  }

  @media (prefers-reduced-motion: reduce) {
    .writings-title { transition: none; }
    .writings-row:hover .writings-title,
    .writings-row:focus .writings-title { text-decoration-color: black; }
    .writings-indicator { display: none; }
    .writings-list.active .writings-title.hovered { color: inherit; text-decoration: underline; text-decoration-color: black; }
    .writings-row span:first-child { transition: none; }
  }
</style>

<script>
  let tabDirection: 'forward' | 'backward' = 'forward';

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Tab') {
      tabDirection = e.shiftKey ? 'backward' : 'forward';
    }
  });

  let observer: MutationObserver | null = null;

  function initWritings(): void {
    observer?.disconnect();
    observer = null;

    const list = document.querySelector('.writings-list') as HTMLElement;
    if (!list) {
      observer = new MutationObserver(() => {
        if (document.querySelector('.writings-list')) initWritings();
      });
      observer.observe(document.body, { childList: true, subtree: true });
      return;
    }
    if (list.dataset.init) return;
    list.dataset.init = '1';

    const indicator = list.querySelector('.writings-indicator') as HTMLElement;
    const rows = list.querySelectorAll('.writings-row');
    const titles = list.querySelectorAll('.writings-title');
    let entryFromTop = false;

    list.addEventListener('mouseenter', (e) => {
      const rect = list.getBoundingClientRect();
      entryFromTop = e.clientY < rect.top + rect.height / 2;
    });

    function activateRow(title: HTMLElement, isKeyboard: boolean = false): void {
      const wasActive = list.classList.contains('active');
      titles.forEach(t => t.classList.remove('hovered'));
      title.classList.add('hovered');

      const listRect = list.getBoundingClientRect();
      const titleRect = title.getBoundingClientRect();
      list.style.setProperty('--indicator-y', `${titleRect.top - listRect.top}px`);
      list.style.setProperty('--indicator-height', `${titleRect.height}px`);
      list.style.setProperty('--indicator-x', `${titleRect.left - listRect.left - 4}px`);
      list.style.setProperty('--indicator-width', `${titleRect.width + 8}px`);

      if (!wasActive) {
        indicator.style.transition = 'none';
        const origin = isKeyboard
          ? (tabDirection === 'forward' ? 'top' : 'bottom')
          : (entryFromTop ? 'top' : 'bottom');
        indicator.style.transformOrigin = origin;
        void indicator.offsetHeight;
        indicator.style.transition = '';
        list.classList.add('active');
      }
    }

    rows.forEach((row) => {
      const title = row.querySelector('.writings-title') as HTMLElement;
      row.addEventListener('mouseenter', () => activateRow(title, false));
      row.addEventListener('focus', () => activateRow(title, true));
    });

    function deactivate(exitOrigin: string): void {
      indicator.style.transformOrigin = exitOrigin;
      list.classList.remove('active');
      titles.forEach(t => t.classList.remove('hovered'));
    }

    list.addEventListener('mouseleave', (e) => {
      const rect = list.getBoundingClientRect();
      const exitedUp = e.clientY < rect.top + rect.height / 2;
      deactivate(exitedUp ? 'top' : 'bottom');
    });

    list.addEventListener('focusout', (e) => {
      const relatedTarget = (e as FocusEvent).relatedTarget as Element | null;
      if (!relatedTarget || !list.contains(relatedTarget)) {
        const exitOrigin = tabDirection === 'forward' ? 'bottom' : 'top';
        deactivate(exitOrigin);
      }
    });
  }

  initWritings();
  document.addEventListener('astro:page-load', initWritings);
</script>
