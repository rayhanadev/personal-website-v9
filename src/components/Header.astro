---
import NavBar from "./NavBar.astro";
import Link from "./Link.astro";

import Glider0 from "../assets/gliders/Glider0.svg";
import Glider1 from "../assets/gliders/Glider1.svg";
import Glider2 from "../assets/gliders/Glider2.svg";
import Glider3 from "../assets/gliders/Glider3.svg";

const gliders = [Glider0, Glider1, Glider2, Glider3];
---

<header class="w-184 flex justify-between items-start font-sans mb-15">
  <div class="flex flex-col gap-4">
    <h1 class="text-[28px] leading-8.5 font-semibold">Ray Arayilakath</h1>
    <p class="text-base leading-5"><Link href="https://x.com/rayhanadev">@rayhanadev</Link> â€¢ Platform Engineer at <Link href="https://million.dev">Million</Link></p>
  </div>
  <div class="flex flex-col-reverse items-end gap-4">
    <NavBar />
    <a
      href="https://purduehackers.com"
      target="_blank"
      rel="noopener noreferrer"
      class="glider-link size-8.25 relative block"
      transition:persist="glider"
      transition:animate="none"
    >
      {gliders.map((src, i) => (
        <img src={src.src} alt="" draggable="false" loading="eager" fetchpriority="high" class:list={["glider-frame size-8.25 absolute inset-0", `frame-${i}`]} />
      ))}
    </a>
  </div>
</header>

<script>
  const ANIMATION_DURATION = 2000;

  function waitForImages(images: NodeListOf<Element>): Promise<void[]> {
    return Promise.all(
      Array.from(images).map(img => {
        const image = img as HTMLImageElement;
        if (image.complete) return Promise.resolve();
        return new Promise<void>(resolve => {
          image.addEventListener('load', () => resolve(), { once: true });
        });
      })
    );
  }

  function initGlider(): void {
    const gliderLink = document.querySelector('.glider-link');
    if (!gliderLink || gliderLink.classList.contains('animation-done')) return;

    const frames = gliderLink.querySelectorAll('.glider-frame');
    if (!frames.length) return;

    waitForImages(frames).then(() => {
      gliderLink.classList.add('loaded');
      setTimeout(() => {
        gliderLink.classList.remove('loaded');
        gliderLink.classList.add('animation-done', 'ready');
      }, ANIMATION_DURATION);
    });
  }

  initGlider();
  document.addEventListener('astro:page-load', initGlider);
</script>

<style>
  .glider-frame { visibility: hidden; transition: opacity 350ms ease; }
  .frame-3 { visibility: visible; }

  .glider-link.loaded .frame-3 { animation: frame3 2s steps(1) forwards; }
  .glider-link.loaded .frame-2 { animation: frame2 2s steps(1) forwards; }
  .glider-link.loaded .frame-1 { animation: frame1 2s steps(1) forwards; }
  .glider-link.loaded .frame-0 { animation: frame0 2s steps(1) forwards; }

  .glider-link.animation-done .glider-frame { visibility: hidden; }
  .glider-link.animation-done .frame-0 { visibility: visible; }

  @keyframes frame3 { 0% { visibility: visible; } 25%, 100% { visibility: hidden; } }
  @keyframes frame2 { 0%, 24.9% { visibility: hidden; } 25% { visibility: visible; } 50% { visibility: hidden; } }
  @keyframes frame1 { 0%, 49.9% { visibility: hidden; } 50% { visibility: visible; } 75% { visibility: hidden; } }
  @keyframes frame0 { 0%, 74.9% { visibility: hidden; } 75%, 100% { visibility: visible; } }

  .glider-link { outline: none; }
  .glider-link.ready:hover img, .glider-link.ready:focus img { opacity: 0; }

  .glider-link::after {
    content: "";
    position: absolute;
    inset: 0;
    background-color: #fbbf24;
    opacity: 0;
    transition: opacity 350ms ease;
    -webkit-mask: url("/src/assets/gliders/Glider0.svg") center / contain no-repeat;
    mask: url("/src/assets/gliders/Glider0.svg") center / contain no-repeat;
  }

  .glider-link.ready:hover::after, .glider-link.ready:focus::after { opacity: 1; }

  @media (prefers-reduced-motion: reduce) {
    .glider-frame { animation: none; transition: none; }
    .frame-0 { visibility: visible; }
    .glider-link::after { transition: none; }
  }
</style>
