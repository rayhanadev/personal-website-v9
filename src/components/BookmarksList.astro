---
import Link from "./Link.astro";

interface CuriusLink {
  link: string;
  title: string;
  modifiedDate: string;
}

const res = await fetch("https://curius.app/api/users/6642/links");
const { userSaved } = await res.json() as { userSaved: CuriusLink[] };
const bookmarks = userSaved.filter((item) => !item.link.includes("x.com/"));

function getHostname(url: string): string {
  try {
    return new URL(url).hostname.replace(/^www\./, '');
  } catch {
    return '';
  }
}
---

<section class="flex-1 mb-6 flex flex-col gap-4 font-sans">
  <h2 class="text-[20px] leading-[22px] font-semibold">Bookmarks</h2>
  <p class="text-base leading-5">
    Articles and links I've saved while browsing. See my <Link href="https://curius.app/ray-arayilakath">Curius profile</Link> for highlights and notes.
  </p>
  <div class="bookmarks-list relative flex flex-col">
    <div class="bookmarks-indicator absolute bg-black rounded-sm pointer-events-none will-change-transform"></div>
    {bookmarks.map((item) => (
      <a
        href={item.link}
        target="_blank"
        rel="noopener noreferrer"
        class="bookmarks-row relative z-1 py-1 outline-none flex gap-6 w-full"
      >
        <span class="text-base leading-5 text-[#979494] shrink-0 w-[100px] transition-colors duration-150 ease-out">
          {new Date(item.modifiedDate).toLocaleDateString("en-GB", { day: "2-digit", month: "short", year: "numeric" })}
        </span>
        <span class="flex gap-2 items-baseline min-w-0">
          <span class="bookmarks-title text-base leading-5 underline underline-offset-2 decoration-[#ccc] truncate transition-colors duration-200 ease-out">
            {item.title}
          </span>
          <span class="text-xs text-[#979494] shrink-0">({getHostname(item.link)})</span>
        </span>
      </a>
    ))}
  </div>
</section>

<style>
  .bookmarks-indicator {
    top: var(--indicator-y, 0);
    left: var(--indicator-x, 0);
    width: var(--indicator-width, 0);
    height: var(--indicator-height, 0);
    transform: scaleY(0);
    transform-origin: bottom;
    transition: transform var(--duration-hover) var(--ease-hover);
  }

  .bookmarks-list.active .bookmarks-indicator {
    transform: scaleY(1);
    transition:
      transform var(--duration-hover) var(--ease-hover),
      top var(--duration-slide) var(--ease-slide),
      left var(--duration-slide) var(--ease-slide),
      width var(--duration-slide) var(--ease-slide),
      height var(--duration-slide) var(--ease-slide);
  }

  .bookmarks-list.active .bookmarks-title.hovered {
    color: white;
    text-decoration: none;
  }

  .bookmarks-row:hover span:first-child,
  .bookmarks-row:focus span:first-child {
    color: #4a4747;
  }

  @media (prefers-reduced-motion: reduce) {
    .bookmarks-title { transition: none; }
    .bookmarks-row:hover .bookmarks-title,
    .bookmarks-row:focus .bookmarks-title { text-decoration-color: black; }
    .bookmarks-indicator { display: none; }
    .bookmarks-list.active .bookmarks-title.hovered { color: inherit; text-decoration: underline; text-decoration-color: black; }
    .bookmarks-row span:first-child { transition: none; }
  }
</style>

<script>
  let tabDirection: 'forward' | 'backward' = 'forward';

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Tab') {
      tabDirection = e.shiftKey ? 'backward' : 'forward';
    }
  });

  function initBookmarks(): void {
    const list = document.querySelector('.bookmarks-list') as HTMLElement;
    if (!list) return;

    const indicator = list.querySelector('.bookmarks-indicator') as HTMLElement;
    const rows = list.querySelectorAll('.bookmarks-row');
    const titles = list.querySelectorAll('.bookmarks-title');
    let entryFromTop = false;

    list.addEventListener('mouseenter', (e) => {
      const rect = list.getBoundingClientRect();
      entryFromTop = e.clientY < rect.top + rect.height / 2;
    });

    function activateRow(title: HTMLElement, isKeyboard: boolean = false): void {
      const wasActive = list.classList.contains('active');
      titles.forEach(t => t.classList.remove('hovered'));
      title.classList.add('hovered');

      const listRect = list.getBoundingClientRect();
      const titleRect = title.getBoundingClientRect();
      list.style.setProperty('--indicator-y', `${titleRect.top - listRect.top}px`);
      list.style.setProperty('--indicator-height', `${titleRect.height}px`);
      list.style.setProperty('--indicator-x', `${titleRect.left - listRect.left - 4}px`);
      list.style.setProperty('--indicator-width', `${titleRect.width + 8}px`);

      if (!wasActive) {
        indicator.style.transition = 'none';
        const origin = isKeyboard
          ? (tabDirection === 'forward' ? 'top' : 'bottom')
          : (entryFromTop ? 'top' : 'bottom');
        indicator.style.transformOrigin = origin;
        void indicator.offsetHeight;
        indicator.style.transition = '';
        list.classList.add('active');
      }
    }

    rows.forEach((row) => {
      const title = row.querySelector('.bookmarks-title') as HTMLElement;

      row.addEventListener('mouseenter', () => activateRow(title, false));

      row.addEventListener('focus', () => activateRow(title, true));
    });

    function deactivate(exitOrigin: string): void {
      indicator.style.transformOrigin = exitOrigin;
      list.classList.remove('active');
      titles.forEach(t => t.classList.remove('hovered'));
    }

    list.addEventListener('mouseleave', (e) => {
      const rect = list.getBoundingClientRect();
      const exitedUp = e.clientY < rect.top + rect.height / 2;
      deactivate(exitedUp ? 'top' : 'bottom');
    });

    list.addEventListener('focusout', (e) => {
      const relatedTarget = (e as FocusEvent).relatedTarget as Element | null;
      if (!relatedTarget || !list.contains(relatedTarget)) {
        const exitOrigin = tabDirection === 'forward' ? 'bottom' : 'top';
        deactivate(exitOrigin);
      }
    });
  }

  initBookmarks();
  document.addEventListener('astro:page-load', initBookmarks);
</script>
